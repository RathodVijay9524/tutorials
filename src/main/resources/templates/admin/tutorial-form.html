<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{admin/layout}">

<head>
    <title th:text="${isEdit} ? 'Edit Tutorial' : 'Add Tutorial'">Tutorial Form</title>
    <!-- Quill Rich Text Editor -->
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
    <style>
        .block-editor {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .content-block {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            position: relative;
            transition: all 0.2s ease;
        }

        .content-block:hover {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 132, 255, 0.1);
        }

        .content-block.dragging {
            opacity: 0.5;
            transform: scale(0.98);
        }

        .block-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .block-type-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .block-type-text {
            background: rgba(99, 102, 241, 0.15);
            color: #818cf8;
        }

        .block-type-code {
            background: rgba(16, 185, 129, 0.15);
            color: #34d399;
        }

        .block-type-image {
            background: rgba(245, 158, 11, 0.15);
            color: #fbbf24;
        }

        .block-type-note {
            background: rgba(59, 130, 246, 0.15);
            color: #60a5fa;
        }

        .block-type-tip {
            background: rgba(16, 185, 129, 0.15);
            color: #34d399;
        }

        .block-type-warning {
            background: rgba(239, 68, 68, 0.15);
            color: #f87171;
        }

        .block-actions {
            display: flex;
            gap: 0.5rem;
        }

        .block-actions button {
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .block-actions button:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-light);
        }

        .block-actions button.delete:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        .add-block-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.02);
            border: 2px dashed var(--border-color);
            border-radius: 10px;
            justify-content: center;
        }

        .add-block-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            color: var(--text-main);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .add-block-btn:hover {
            border-color: var(--primary-color);
            background: rgba(0, 132, 255, 0.1);
            transform: translateY(-2px);
        }

        .add-block-btn i {
            font-size: 1rem;
        }

        /* Quill Editor Customization */
        .ql-container {
            min-height: 150px;
            font-size: 1rem;
        }

        .ql-editor {
            min-height: 150px;
        }

        .ql-toolbar.ql-snow,
        .ql-container.ql-snow {
            border-color: var(--border-color);
        }

        .ql-toolbar.ql-snow {
            border-radius: 8px 8px 0 0;
            background: rgba(255, 255, 255, 0.03);
        }

        .ql-container.ql-snow {
            border-radius: 0 0 8px 8px;
        }

        /* Code Block */
        .code-block-editor {
            font-family: 'Fira Code', 'Monaco', monospace;
            background: #1e1e2e;
            color: #cdd6f4;
            padding: 1rem;
            border-radius: 8px;
            min-height: 120px;
            border: none;
            width: 100%;
            resize: vertical;
        }

        .code-language-select {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            color: var(--text-main);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
        }

        /* Image Block */
        .image-upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 10px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .image-upload-area:hover {
            border-color: var(--primary-color);
            background: rgba(0, 132, 255, 0.05);
        }

        .image-upload-area.has-image {
            padding: 0.5rem;
            border-style: solid;
        }

        .image-upload-area img {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
        }

        /* Note Block */
        .note-block {
            border-left: 4px solid;
            padding-left: 1rem;
        }

        .note-block.note {
            border-color: #60a5fa;
            background: rgba(59, 130, 246, 0.05);
        }

        .note-block.tip {
            border-color: #34d399;
            background: rgba(16, 185, 129, 0.05);
        }

        .note-block.warning {
            border-color: #f87171;
            background: rgba(239, 68, 68, 0.05);
        }

        /* Drag Handle */
        .drag-handle {
            cursor: grab;
            padding: 4px;
            color: var(--text-muted);
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        /* Preview Mode */
        .preview-content {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 12px;
            min-height: 300px;
        }

        .preview-content h1,
        .preview-content h2,
        .preview-content h3 {
            margin-top: 1.5rem;
            margin-bottom: 1rem;
        }

        .preview-content pre {
            background: #1e1e2e;
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
        }

        .preview-content img {
            max-width: 100%;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .tab-btn {
            padding: 10px 20px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .tab-btn:hover:not(.active) {
            color: var(--text-light);
        }
    </style>
</head>

<body>
    <div layout:fragment="content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 mb-0" th:text="${isEdit} ? 'Edit Tutorial' : 'Create New Tutorial'">Tutorial Form</h1>
            <a th:href="@{/admin/tutorials}" class="btn btn-outline-light">
                <i class="fas fa-arrow-left me-2"></i>Back to List
            </a>
        </div>

        <form th:action="@{/admin/tutorials/save}" th:object="${tutorial}" method="post" enctype="multipart/form-data"
            id="tutorialForm">
            <input type="hidden" th:field="*{id}">
            <input type="hidden" name="content" id="contentField">

            <div class="row g-4">
                <!-- Left Column - Main Content -->
                <div class="col-lg-8">
                    <!-- Basic Info Card -->
                    <div class="admin-card mb-4">
                        <h5 class="mb-4"><i class="fas fa-info-circle me-2 text-primary"></i>Basic Information</h5>
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label">Tutorial Title *</label>
                                <input type="text" th:field="*{title}" class="form-control form-control-lg" required
                                    placeholder="e.g., Understanding Java Collections Framework" id="titleInput">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">URL Slug *</label>
                                <div class="input-group">
                                    <span class="input-group-text">/tutorials/</span>
                                    <input type="text" th:field="*{slug}" class="form-control" required
                                        placeholder="java-collections" id="slugInput">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Estimated Time</label>
                                <div class="input-group">
                                    <input type="number" th:field="*{estimatedMinutes}" class="form-control" value="15"
                                        min="1">
                                    <span class="input-group-text">minutes</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Content Editor Card -->
                    <div class="admin-card">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="mb-0"><i class="fas fa-edit me-2 text-primary"></i>Tutorial Content</h5>
                            <div class="btn-group">
                                <button type="button" class="tab-btn active" onclick="switchTab('editor')">
                                    <i class="fas fa-edit me-1"></i> Editor
                                </button>
                                <button type="button" class="tab-btn" onclick="switchTab('preview')">
                                    <i class="fas fa-eye me-1"></i> Preview
                                </button>
                            </div>
                        </div>

                        <!-- Editor Tab -->
                        <div id="editorTab">
                            <!-- Content Blocks Container -->
                            <div id="blocksContainer">
                                <!-- Blocks will be added dynamically here -->
                            </div>

                            <!-- Add New Block Toolbar -->
                            <div class="add-block-toolbar">
                                <button type="button" class="add-block-btn" onclick="addBlock('text')">
                                    <i class="fas fa-paragraph text-primary"></i> Text
                                </button>
                                <button type="button" class="add-block-btn" onclick="addBlock('code')">
                                    <i class="fas fa-code text-success"></i> Code
                                </button>
                                <button type="button" class="add-block-btn" onclick="addBlock('image')">
                                    <i class="fas fa-image text-warning"></i> Image
                                </button>
                                <button type="button" class="add-block-btn" onclick="addBlock('note')">
                                    <i class="fas fa-info-circle text-info"></i> Note
                                </button>
                                <button type="button" class="add-block-btn" onclick="addBlock('tip')">
                                    <i class="fas fa-lightbulb text-success"></i> Tip
                                </button>
                                <button type="button" class="add-block-btn" onclick="addBlock('warning')">
                                    <i class="fas fa-exclamation-triangle text-danger"></i> Warning
                                </button>
                            </div>
                        </div>

                        <!-- Preview Tab -->
                        <div id="previewTab" class="d-none">
                            <div class="preview-content" id="previewContent">
                                <p class="text-muted text-center py-5">Content preview will appear here...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column - Settings -->
                <div class="col-lg-4">
                    <!-- Publish Settings -->
                    <div class="admin-card mb-4">
                        <h5 class="mb-4"><i class="fas fa-cog me-2 text-primary"></i>Settings</h5>
                        <div class="mb-3">
                            <label class="form-label">Category *</label>
                            <select th:field="*{categoryId}" class="form-select" required>
                                <option value="">-- Select Category --</option>
                                <option th:each="cat : ${categories}" th:value="${cat.id}" th:text="${cat.name}">
                                    Category</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Difficulty *</label>
                            <select th:field="*{difficulty}" class="form-select" required>
                                <option value="BEGINNER">ðŸŸ¢ Beginner</option>
                                <option value="INTERMEDIATE">ðŸŸ¡ Intermediate</option>
                                <option value="ADVANCED">ðŸ”´ Advanced</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Display Order</label>
                            <input type="number" th:field="*{displayOrder}" class="form-control" value="0">
                        </div>
                    </div>

                    <!-- SEO Settings -->
                    <div class="admin-card mb-4">
                        <h5 class="mb-4"><i class="fas fa-search me-2 text-primary"></i>SEO Settings</h5>
                        <div class="mb-3">
                            <label class="form-label">Meta Title</label>
                            <input type="text" th:field="*{metaTitle}" class="form-control" placeholder="SEO title">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Keywords</label>
                            <input type="text" th:field="*{keywords}" class="form-control"
                                placeholder="java, collections">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Meta Description</label>
                            <textarea th:field="*{metaDescription}" class="form-control" rows="3"
                                placeholder="Brief description"></textarea>
                        </div>
                    </div>

                    <!-- Code Example (Quick Add) -->
                    <div class="admin-card mb-4">
                        <h5 class="mb-4"><i class="fas fa-terminal me-2 text-primary"></i>Main Code Example</h5>
                        <textarea th:field="*{codeExample}" class="form-control font-monospace" rows="6"
                            placeholder="public class Main { ... }" style="font-size: 0.85rem;"></textarea>
                        <small class="text-muted">This appears in the tutorial sidebar</small>
                    </div>

                    <!-- Video (Optional) -->
                    <div class="admin-card">
                        <h5 class="mb-4"><i class="fas fa-video me-2 text-primary"></i>Video (Optional)</h5>
                        <div class="mb-3">
                            <label class="form-label">Video URL</label>
                            <input type="url" th:field="*{videoUrl}" class="form-control"
                                placeholder="https://youtube.com/...">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Duration</label>
                            <input type="text" th:field="*{videoDuration}" class="form-control" placeholder="12:30">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Submit Actions -->
            <div class="admin-card mt-4">
                <div class="d-flex justify-content-between align-items-center">
                    <a th:href="@{/admin/tutorials}" class="btn btn-outline-secondary">
                        <i class="fas fa-times me-2"></i>Cancel
                    </a>
                    <div>
                        <button type="button" class="btn btn-outline-primary me-2" onclick="saveDraft()">
                            <i class="fas fa-save me-2"></i>Save Draft
                        </button>
                        <button type="submit" class="btn btn-admin">
                            <i class="fas fa-check me-2"></i>Publish Tutorial
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <th:block layout:fragment="scripts">
        <!-- Quill Editor -->
        <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
        <script th:inline="javascript">
            /*<![CDATA[*/
            let blockCounter = 0;
            let blocks = [];
            const existingContent = /*[[${tutorial.content}]]*/ '';

            document.addEventListener('DOMContentLoaded', function () {
                // Auto-generate slug from title
                document.getElementById('titleInput').addEventListener('blur', function () {
                    const slugInput = document.getElementById('slugInput');
                    if (this.value && !slugInput.value) {
                        slugInput.value = this.value.toLowerCase()
                            .replace(/[^\w\s-]/g, '')
                            .replace(/[\s_-]+/g, '-')
                            .replace(/^-+|-+$/g, '');
                    }
                });

                // Load existing content if editing
                if (existingContent) {
                    try {
                        const parsed = JSON.parse(existingContent);
                        if (Array.isArray(parsed)) {
                            parsed.forEach(block => addBlock(block.type, block.content, block.meta));
                        } else {
                            // Legacy content - add as single text block
                            addBlock('text', existingContent);
                        }
                    } catch (e) {
                        // Plain text content
                        if (existingContent.trim()) {
                            addBlock('text', existingContent);
                        }
                    }
                }

                // Add initial text block if empty
                if (blocks.length === 0) {
                    addBlock('text');
                }

                // Form submission - compile blocks to JSON
                document.getElementById('tutorialForm').addEventListener('submit', function (e) {
                    compileContent();
                });
            });

            function addBlock(type, content = '', meta = {}) {
                const id = ++blockCounter;
                const container = document.getElementById('blocksContainer');

                const blockHtml = createBlockHtml(id, type, content, meta);
                container.insertAdjacentHTML('beforeend', blockHtml);

                blocks.push({ id, type, content, meta });

                // Initialize Quill for text blocks
                if (type === 'text') {
                    const quill = new Quill(`#editor-${id}`, {
                        theme: 'snow',
                        placeholder: 'Write your content here...',
                        modules: {
                            toolbar: [
                                [{ 'header': [1, 2, 3, false] }],
                                ['bold', 'italic', 'underline', 'strike'],
                                [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                                ['blockquote', 'code-block'],
                                ['link'],
                                ['clean']
                            ]
                        }
                    });
                    if (content) {
                        quill.root.innerHTML = content;
                    }
                    quill.on('text-change', () => updateBlockContent(id, quill.root.innerHTML));
                }

                // Initialize note blocks with Quill too
                if (type === 'note' || type === 'tip' || type === 'warning') {
                    const quill = new Quill(`#editor-${id}`, {
                        theme: 'snow',
                        placeholder: `Enter ${type} content...`,
                        modules: {
                            toolbar: [
                                ['bold', 'italic'],
                                ['link'],
                                ['clean']
                            ]
                        }
                    });
                    if (content) {
                        quill.root.innerHTML = content;
                    }
                    quill.on('text-change', () => updateBlockContent(id, quill.root.innerHTML));
                }
            }

            function createBlockHtml(id, type, content, meta) {
                const typeIcons = {
                    'text': 'fa-paragraph',
                    'code': 'fa-code',
                    'image': 'fa-image',
                    'note': 'fa-info-circle',
                    'tip': 'fa-lightbulb',
                    'warning': 'fa-exclamation-triangle'
                };

                let innerContent = '';

                if (type === 'text' || type === 'note' || type === 'tip' || type === 'warning') {
                    const noteClass = (type === 'note' || type === 'tip' || type === 'warning') ? `note-block ${type}` : '';
                    innerContent = `<div id="editor-${id}" class="${noteClass}"></div>`;
                } else if (type === 'code') {
                    innerContent = `
                        <div class="d-flex gap-2 mb-2">
                            <select class="code-language-select" onchange="updateBlockMeta(${id}, 'language', this.value)">
                                <option value="java" ${meta.language === 'java' ? 'selected' : ''}>Java</option>
                                <option value="javascript" ${meta.language === 'javascript' ? 'selected' : ''}>JavaScript</option>
                                <option value="python" ${meta.language === 'python' ? 'selected' : ''}>Python</option>
                                <option value="html" ${meta.language === 'html' ? 'selected' : ''}>HTML</option>
                                <option value="css" ${meta.language === 'css' ? 'selected' : ''}>CSS</option>
                                <option value="sql" ${meta.language === 'sql' ? 'selected' : ''}>SQL</option>
                                <option value="bash" ${meta.language === 'bash' ? 'selected' : ''}>Bash</option>
                            </select>
                            <input type="text" class="form-control form-control-sm" style="max-width: 200px;" 
                                   placeholder="Filename (optional)" value="${meta.filename || ''}"
                                   onchange="updateBlockMeta(${id}, 'filename', this.value)">
                        </div>
                        <textarea class="code-block-editor" rows="8" 
                                  oninput="updateBlockContent(${id}, this.value)"
                                  placeholder="// Write your code here...">${content || ''}</textarea>
                    `;
                } else if (type === 'image') {
                    innerContent = `
                        <div class="image-upload-area ${content ? 'has-image' : ''}" onclick="document.getElementById('imageInput-${id}').click()">
                            ${content ? `<img src="${content}" alt="Uploaded image">` : `
                                <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                <p class="mb-1">Click to upload an image</p>
                                <small class="text-muted">Supports JPG, PNG, GIF up to 10MB</small>
                            `}
                        </div>
                        <input type="file" id="imageInput-${id}" accept="image/*" style="display:none" onchange="handleImageUpload(${id}, this)">
                        <input type="text" class="form-control mt-2" placeholder="Image caption (optional)"
                               value="${meta.caption || ''}" onchange="updateBlockMeta(${id}, 'caption', this.value)">
                        <input type="text" class="form-control mt-2" placeholder="Or paste image URL..."
                               value="${content || ''}" onchange="updateBlockContent(${id}, this.value); refreshImagePreview(${id}, this.value)">
                    `;
                }

                return `
                    <div class="content-block" id="block-${id}" draggable="true" 
                         ondragstart="dragStart(event)" ondragover="dragOver(event)" ondrop="drop(event)">
                        <div class="block-header">
                            <div class="d-flex align-items-center gap-2">
                                <span class="drag-handle"><i class="fas fa-grip-vertical"></i></span>
                                <span class="block-type-badge block-type-${type}">
                                    <i class="fas ${typeIcons[type]}"></i> ${type}
                                </span>
                            </div>
                            <div class="block-actions">
                                <button type="button" onclick="moveBlock(${id}, -1)" title="Move Up"><i class="fas fa-chevron-up"></i></button>
                                <button type="button" onclick="moveBlock(${id}, 1)" title="Move Down"><i class="fas fa-chevron-down"></i></button>
                                <button type="button" onclick="duplicateBlock(${id})" title="Duplicate"><i class="fas fa-copy"></i></button>
                                <button type="button" class="delete" onclick="deleteBlock(${id})" title="Delete"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                        ${innerContent}
                    </div>
                `;
            }

            function updateBlockContent(id, content) {
                const block = blocks.find(b => b.id === id);
                if (block) block.content = content;
            }

            function updateBlockMeta(id, key, value) {
                const block = blocks.find(b => b.id === id);
                if (block) {
                    if (!block.meta) block.meta = {};
                    block.meta[key] = value;
                }
            }

            function deleteBlock(id) {
                if (blocks.length <= 1) {
                    alert('You must have at least one content block');
                    return;
                }
                document.getElementById(`block-${id}`).remove();
                blocks = blocks.filter(b => b.id !== id);
            }

            function moveBlock(id, direction) {
                const index = blocks.findIndex(b => b.id === id);
                const newIndex = index + direction;
                if (newIndex < 0 || newIndex >= blocks.length) return;

                // Swap in array
                [blocks[index], blocks[newIndex]] = [blocks[newIndex], blocks[index]];

                // Reorder DOM
                const container = document.getElementById('blocksContainer');
                const children = Array.from(container.children);
                [children[index], children[newIndex]] = [children[newIndex], children[index]];
                children.forEach(child => container.appendChild(child));
            }

            function duplicateBlock(id) {
                const block = blocks.find(b => b.id === id);
                if (block) {
                    addBlock(block.type, block.content, { ...block.meta });
                }
            }

            function handleImageUpload(id, input) {
                const file = input.files[0];
                if (!file) return;

                const formData = new FormData();
                formData.append('file', file);

                // Upload to server
                fetch('/api/v1/files/upload', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]')?.content
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.url) {
                            updateBlockContent(id, data.url);
                            refreshImagePreview(id, data.url);
                        }
                    })
                    .catch(err => {
                        // Fallback to local preview
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            updateBlockContent(id, e.target.result);
                            refreshImagePreview(id, e.target.result);
                        };
                        reader.readAsDataURL(file);
                    });
            }

            function refreshImagePreview(id, url) {
                const uploadArea = document.querySelector(`#block-${id} .image-upload-area`);
                if (url) {
                    uploadArea.classList.add('has-image');
                    uploadArea.innerHTML = `<img src="${url}" alt="Uploaded image">`;
                } else {
                    uploadArea.classList.remove('has-image');
                    uploadArea.innerHTML = `
                        <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                        <p class="mb-1">Click to upload an image</p>
                        <small class="text-muted">Supports JPG, PNG, GIF up to 10MB</small>
                    `;
                }
            }

            // Drag and Drop
            let draggedBlock = null;
            function dragStart(e) {
                draggedBlock = e.target.closest('.content-block');
                draggedBlock.classList.add('dragging');
            }
            function dragOver(e) {
                e.preventDefault();
            }
            function drop(e) {
                e.preventDefault();
                const target = e.target.closest('.content-block');
                if (target && draggedBlock !== target) {
                    const container = document.getElementById('blocksContainer');
                    const allBlocks = Array.from(container.children);
                    const draggedIndex = allBlocks.indexOf(draggedBlock);
                    const targetIndex = allBlocks.indexOf(target);

                    if (draggedIndex < targetIndex) {
                        target.after(draggedBlock);
                    } else {
                        target.before(draggedBlock);
                    }

                    // Update blocks array order
                    const draggedId = parseInt(draggedBlock.id.replace('block-', ''));
                    const targetId = parseInt(target.id.replace('block-', ''));
                    const oldIndex = blocks.findIndex(b => b.id === draggedId);
                    const newIndex = blocks.findIndex(b => b.id === targetId);
                    const [removed] = blocks.splice(oldIndex, 1);
                    blocks.splice(newIndex, 0, removed);
                }
                draggedBlock.classList.remove('dragging');
            }

            function switchTab(tab) {
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');

                if (tab === 'editor') {
                    document.getElementById('editorTab').classList.remove('d-none');
                    document.getElementById('previewTab').classList.add('d-none');
                } else {
                    document.getElementById('editorTab').classList.add('d-none');
                    document.getElementById('previewTab').classList.remove('d-none');
                    generatePreview();
                }
            }

            function generatePreview() {
                let html = '';
                blocks.forEach(block => {
                    if (block.type === 'text') {
                        html += block.content;
                    } else if (block.type === 'code') {
                        const lang = block.meta?.language || 'java';
                        const filename = block.meta?.filename ? `<div class="text-muted small mb-1">${block.meta.filename}</div>` : '';
                        html += `${filename}<pre><code class="language-${lang}">${escapeHtml(block.content)}</code></pre>`;
                    } else if (block.type === 'image') {
                        const caption = block.meta?.caption ? `<p class="text-center text-muted small">${block.meta.caption}</p>` : '';
                        html += `<figure class="text-center"><img src="${block.content}" alt="${block.meta?.caption || ''}" style="max-width:100%;">${caption}</figure>`;
                    } else if (block.type === 'note' || block.type === 'tip' || block.type === 'warning') {
                        const icons = { note: 'info-circle', tip: 'lightbulb', warning: 'exclamation-triangle' };
                        const colors = { note: 'primary', tip: 'success', warning: 'danger' };
                        html += `<div class="alert alert-${colors[block.type]}"><i class="fas fa-${icons[block.type]} me-2"></i>${block.content}</div>`;
                    }
                });
                document.getElementById('previewContent').innerHTML = html || '<p class="text-muted text-center py-5">No content yet...</p>';
            }

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text || '';
                return div.innerHTML;
            }

            function compileContent() {
                // Compile blocks to JSON and set hidden field
                const contentData = blocks.map(b => ({
                    type: b.type,
                    content: b.content,
                    meta: b.meta || {}
                }));
                document.getElementById('contentField').value = JSON.stringify(contentData);
            }

            function saveDraft() {
                compileContent();
                // Could save to localStorage or server draft endpoint
                localStorage.setItem('tutorialDraft', document.getElementById('contentField').value);
                alert('Draft saved locally!');
            }
            /*]]>*/
        </script>
    </th:block>
</body>

</html>