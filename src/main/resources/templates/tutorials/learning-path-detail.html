<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{tutorials/layout}">

<head>
    <title th:text="${path.name} + ' - Learning Path'">Learning Path Detail</title>
    <link rel="stylesheet" th:href="@{/css/learning-paths.css}">
    <style>
        .path-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 1rem;
            padding: 2rem;
            color: white;
            margin-bottom: 2rem;
        }

        .path-header h1 {
            color: white;
        }

        .step-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 1.25rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .step-card:hover {
            border-color: var(--primary-color);
            transform: translateX(5px);
        }

        .step-card.completed {
            border-left: 4px solid #22c55e;
            background: rgba(34, 197, 94, 0.05);
        }

        .step-card.current {
            border-left: 4px solid var(--primary-color);
            background: rgba(0, 132, 255, 0.05);
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            margin-right: 1rem;
            flex-shrink: 0;
        }

        .step-number.completed {
            background: #22c55e;
            color: white;
        }

        .step-number.current {
            background: var(--primary-color);
            color: white;
        }

        .step-number.pending {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            color: var(--text-muted);
        }

        .progress-bar-container {
            background: var(--card-bg);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .star-rating {
            font-size: 1.5rem;
            cursor: pointer;
        }

        .star-rating .star {
            transition: all 0.2s ease;
            margin-right: 0.25rem;
        }

        .star-rating .star:hover {
            transform: scale(1.2);
        }
    </style>
</head>

<body>
    <div layout:fragment="content">
        <!-- Path Header -->
        <div class="path-header" th:if="${path}">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div class="mb-2">
                        <span th:if="${path.isAiGenerated}" class="badge bg-light text-dark me-2">
                            <i class="fas fa-robot me-1"></i>AI Generated
                        </span>
                        <span th:class="'badge bg-' + ${path.difficultyLevel?.toLowerCase() == 'beginner' ? 'success' : (path.difficultyLevel?.toLowerCase() == 'intermediate' ? 'warning' : 'danger')}"
                            th:text="${path.difficultyLevel}">BEGINNER</span>
                    </div>
                    <h1 class="mb-2" th:text="${path.name}">Learning Path Name</h1>
                    <p class="mb-3" style="color: rgba(255,255,255,0.9);" th:text="${path.description}">Description</p>
                    <div th:if="${path.goal != null}" class="mb-2">
                        <i class="fas fa-bullseye me-2"></i>
                        <strong>Goal:</strong> <span th:text="${path.goal}">Goal</span>
                    </div>
                </div>
                <div class="text-end">
                    <div class="mb-2">
                        <div class="h4 mb-0" th:text="${path.estimatedHours + ' hours'}">10 hours</div>
                        <small style="color: rgba(255,255,255,0.8);">Estimated Time</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- User Progress (if enrolled) -->
        <div th:if="${path.userProgress != null}" class="progress-bar-container">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h3 class="h5 mb-0">Your Progress</h3>
                <span class="badge bg-primary" th:text="${path.userProgress.progressPercentage + '%'}">0%</span>
            </div>
            <div class="progress" style="height: 10px; border-radius: 0.5rem;">
                <div class="progress-bar bg-primary" role="progressbar"
                    th:style="'width: ' + ${path.userProgress.progressPercentage} + '%'"
                    th:attr="aria-valuenow=${path.userProgress.progressPercentage}"
                    aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" th:text="${path.userProgress.completedSteps}">0</div>
                    <div class="stat-label">Completed</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" th:text="${path.userProgress.totalSteps}">0</div>
                    <div class="stat-label">Total Steps</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" th:if="${path.userProgress.estimatedCompletionDate != null}"
                        th:text="${#temporals.format(path.userProgress.estimatedCompletionDate, 'MMM dd')}">Jan 15</div>
                    <div class="stat-label">Est. Completion</div>
                </div>
            </div>
        </div>

        <!-- Enroll/Unenroll Button -->
        <div class="text-center mb-4" style="animation: fadeIn 0.8s ease-out;">
            <div th:if="${path.userProgress == null}">
                <button id="enroll-btn" class="btn btn-primary btn-lg rounded-pill px-5 hover-glow"
                    th:attr="data-path-id=${path.id}">
                    <i class="fas fa-play me-2"></i>Start Learning Path
                </button>
                <p class="text-muted small mt-2">
                    <i class="fas fa-info-circle me-1"></i>Click to enroll and start tracking your progress
                </p>
            </div>
            <div th:if="${path.userProgress != null}">
                <button id="unenroll-btn" class="btn btn-outline-danger btn-lg rounded-pill px-5"
                    th:attr="data-path-id=${path.id}">
                    <i class="fas fa-sign-out-alt me-2"></i>Leave Learning Path
                </button>
                <p class="text-muted small mt-2">
                    <i class="fas fa-info-circle me-1"></i>You can re-enroll anytime to continue your progress
                </p>
            </div>
        </div>

        <!-- Learning Path Steps -->
        <div class="mb-4">
            <h2 class="h4 mb-4">
                <i class="fas fa-list-ol me-2"></i>Learning Steps
                <span class="badge bg-secondary ms-2" th:text="${path.steps != null ? path.steps.size() : 0}">0</span>
            </h2>

            <div id="steps-container">
                <div th:each="step, iterStat : ${path.steps}" class="step-card"
                    th:classappend="${step.completed ? 'completed' : ''}"
                    th:attr="data-step-order=${step.stepOrder}, data-tutorial-id=${step.tutorialId}">
                    <div class="d-flex align-items-start">
                        <div th:class="'step-number ' + ${step.completed ? 'completed' : (iterStat.index == 0 ? 'current' : 'pending')}"
                            th:text="${step.stepOrder}">1</div>
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h4 class="h6 mb-1" th:text="${step.tutorialTitle}">Tutorial Title</h4>
                                    <div class="mb-2">
                                        <span class="badge bg-secondary me-2"
                                            th:text="${step.tutorialDifficulty}">BEGINNER</span>
                                        <span class="text-muted small"
                                            th:text="${step.tutorialEstimatedMinutes + ' min'}">10 min</span>
                                    </div>
                                </div>
                                <div th:if="${step.completed}">
                                    <i class="fas fa-check-circle text-success fa-lg"></i>
                                </div>
                            </div>
                            <div class="d-flex gap-2">
                                <a th:href="@{/tutorials/view/{slug}(slug=${step.tutorialSlug})}"
                                    class="btn btn-sm btn-primary rounded-pill">
                                    <i class="fas fa-book-open me-1"></i>Start Tutorial
                                </a>
                                <span th:if="${step.isOptional}" class="badge bg-info align-self-center">Optional</span>
                            </div>
                            <p th:if="${step.notes != null}" class="text-muted small mt-2 mb-0"
                                th:text="${step.notes}">Notes</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Rating Section -->
        <div class="card mb-4" style="background: var(--card-bg); border: 1px solid var(--border-color);">
            <div class="card-body">
                <h3 class="h5 mb-4">
                    <i class="fas fa-star text-warning me-2"></i>Rate This Learning Path
                </h3>
                <div id="rating-section">
                    <div class="mb-3">
                        <label class="form-label">Your Rating</label>
                        <div class="star-rating" id="star-rating">
                            <i class="far fa-star star" data-rating="1"></i>
                            <i class="far fa-star star" data-rating="2"></i>
                            <i class="far fa-star star" data-rating="3"></i>
                            <i class="far fa-star star" data-rating="4"></i>
                            <i class="far fa-star star" data-rating="5"></i>
                        </div>
                        <small class="text-muted" id="rating-text">Click to rate</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Review (Optional)</label>
                        <textarea class="form-control bg-dark border-secondary text-light" id="review-text" 
                                  rows="3" placeholder="Share your experience with this learning path..."></textarea>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary" id="submit-rating-btn">
                            <i class="fas fa-check me-1"></i>Submit Rating
                        </button>
                        <button class="btn btn-outline-danger" id="delete-rating-btn" style="display: none;">
                            <i class="fas fa-trash me-1"></i>Delete Rating
                        </button>
                    </div>
                </div>
                <div id="user-rating-display" style="display: none;" class="mt-3 p-3 bg-dark rounded">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="mb-2">
                                <span id="user-rating-stars"></span>
                                <span class="ms-2 text-muted">Your Rating</span>
                            </div>
                            <p id="user-review-text" class="mb-0 text-muted"></p>
                        </div>
                        <button class="btn btn-sm btn-outline-secondary" id="edit-rating-btn">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- All Ratings Section -->
        <div class="card mb-4" style="background: var(--card-bg); border: 1px solid var(--border-color);">
            <div class="card-body">
                <h3 class="h5 mb-4">
                    <i class="fas fa-comments me-2"></i>Reviews & Ratings
                    <span class="badge bg-secondary ms-2" id="ratings-count">0</span>
                </h3>
                <div id="ratings-list">
                    <p class="text-muted text-center py-3">No ratings yet. Be the first to rate!</p>
                </div>
            </div>
        </div>

        <!-- Path Stats -->
        <div class="row g-4 mb-4">
            <div class="col-md-4">
                <div class="premium-card p-4 text-center stat-item hover-lift">
                    <i class="fas fa-users fa-2x text-primary mb-3" style="transition: transform 0.3s;"></i>
                    <div class="h3 mb-1 stat-value" th:text="${path.enrollmentCount}">0</div>
                    <div class="text-muted stat-label">Enrolled</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="premium-card p-4 text-center stat-item hover-lift">
                    <i class="fas fa-check-circle fa-2x text-success mb-3" style="transition: transform 0.3s;"></i>
                    <div class="h3 mb-1 stat-value" th:text="${path.completionCount}">0</div>
                    <div class="text-muted stat-label">Completed</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="premium-card p-4 text-center stat-item hover-lift">
                    <i class="fas fa-star fa-2x text-warning mb-3" style="transition: transform 0.3s;"></i>
                    <div class="h3 mb-1 stat-value"
                        th:text="${path.averageRating != null ? #numbers.formatDecimal(path.averageRating, 1, 1) : '0.0'}">4.5</div>
                    <div class="text-muted stat-label">
                        Average Rating
                        <span class="small d-block" th:text="'(' + ${path.ratingCount} + ' ratings)'">(0 ratings)</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script th:src="@{/js/learning-paths.js}"></script>
    <script th:inline="javascript">
        const pathId = /*[[${path.id}]]*/ null;
        const isEnrolled = /*[[${path.userProgress != null}]]*/ false;
        
        // Rating functionality
        let currentRating = 0;
        let userRating = null;

        // Star rating interaction
        const stars = document.querySelectorAll('.star');
        stars.forEach(star => {
            star.addEventListener('click', () => {
                currentRating = parseInt(star.dataset.rating);
                updateStarDisplay();
            });
            star.addEventListener('mouseenter', () => {
                const rating = parseInt(star.dataset.rating);
                highlightStars(rating);
            });
        });

        document.getElementById('star-rating').addEventListener('mouseleave', () => {
            updateStarDisplay();
        });

        function highlightStars(rating) {
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.classList.remove('far');
                    star.classList.add('fas', 'text-warning');
                } else {
                    star.classList.remove('fas', 'text-warning');
                    star.classList.add('far');
                }
            });
        }

        function updateStarDisplay() {
            highlightStars(currentRating);
            const texts = ['', 'Poor', 'Fair', 'Good', 'Very Good', 'Excellent'];
            document.getElementById('rating-text').textContent = currentRating > 0 ? texts[currentRating] : 'Click to rate';
        }

        // Load user rating
        async function loadUserRating() {
            try {
                const response = await fetch(`/api/v1/learning-paths/${pathId}/my-rating`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.status === 'success' && data.data) {
                        userRating = data.data;
                        currentRating = userRating.rating;
                        displayUserRating();
                    }
                }
            } catch (error) {
                console.error('Error loading user rating:', error);
            }
        }

        function displayUserRating() {
            if (userRating) {
                document.getElementById('rating-section').style.display = 'none';
                document.getElementById('user-rating-display').style.display = 'block';
                document.getElementById('delete-rating-btn').style.display = 'inline-block';
                
                let starsHtml = '';
                for (let i = 1; i <= 5; i++) {
                    starsHtml += `<i class="fas fa-star text-warning"></i>`;
                }
                document.getElementById('user-rating-stars').innerHTML = starsHtml;
                document.getElementById('user-review-text').textContent = userRating.review || 'No review provided';
            } else {
                document.getElementById('rating-section').style.display = 'block';
                document.getElementById('user-rating-display').style.display = 'none';
                document.getElementById('delete-rating-btn').style.display = 'none';
            }
        }

        // Submit rating
        document.getElementById('submit-rating-btn').addEventListener('click', async () => {
            if (currentRating === 0) {
                showToast('Please select a rating', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/v1/learning-paths/${pathId}/rate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        rating: currentRating,
                        review: document.getElementById('review-text').value
                    })
                });

                const data = await response.json();
                if (response.ok && data.status === 'success') {
                    showToast('Rating submitted successfully!', 'success');
                    userRating = data.data;
                    displayUserRating();
                    loadRatings();
                    location.reload(); // Reload to update average rating
                } else {
                    showToast(data.message || 'Failed to submit rating', 'error');
                }
            } catch (error) {
                console.error('Error submitting rating:', error);
                showToast('Failed to submit rating', 'error');
            }
        });

        // Delete rating
        document.getElementById('delete-rating-btn').addEventListener('click', async () => {
            if (!confirm('Are you sure you want to delete your rating?')) return;

            try {
                const response = await fetch(`/api/v1/learning-paths/${pathId}/rate`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                if (response.ok && data.status === 'success') {
                    showToast('Rating deleted successfully', 'success');
                    userRating = null;
                    currentRating = 0;
                    document.getElementById('review-text').value = '';
                    displayUserRating();
                    loadRatings();
                    location.reload();
                } else {
                    showToast(data.message || 'Failed to delete rating', 'error');
                }
            } catch (error) {
                console.error('Error deleting rating:', error);
                showToast('Failed to delete rating', 'error');
            }
        });

        // Edit rating
        document.getElementById('edit-rating-btn').addEventListener('click', () => {
            document.getElementById('rating-section').style.display = 'block';
            document.getElementById('user-rating-display').style.display = 'none';
            updateStarDisplay();
            document.getElementById('review-text').value = userRating?.review || '';
        });

        // Load all ratings
        async function loadRatings() {
            try {
                const response = await fetch(`/api/v1/learning-paths/${pathId}/ratings`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.status === 'success' && data.data) {
                        renderRatings(data.data);
                    }
                }
            } catch (error) {
                console.error('Error loading ratings:', error);
            }
        }

        function renderRatings(ratings) {
            const container = document.getElementById('ratings-list');
            document.getElementById('ratings-count').textContent = ratings.length;

            if (ratings.length === 0) {
                container.innerHTML = '<p class="text-muted text-center py-3">No ratings yet. Be the first to rate!</p>';
                return;
            }

            container.innerHTML = ratings.map(rating => `
                <div class="border-bottom pb-3 mb-3">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <strong>${rating.username || 'Anonymous'}</strong>
                            <div class="mt-1">
                                ${Array(rating.rating).fill(0).map(() => '<i class="fas fa-star text-warning"></i>').join('')}
                                ${Array(5 - rating.rating).fill(0).map(() => '<i class="far fa-star text-warning"></i>').join('')}
                            </div>
                        </div>
                        <small class="text-muted">${new Date(rating.createdAt).toLocaleDateString()}</small>
                    </div>
                    ${rating.review ? `<p class="text-muted mb-0">${rating.review}</p>` : ''}
                </div>
            `).join('');
        }

        // Unenroll functionality
        const unenrollBtn = document.getElementById('unenroll-btn');
        if (unenrollBtn) {
            unenrollBtn.addEventListener('click', async () => {
                if (!confirm('Are you sure you want to leave this learning path? Your progress will be saved, but you\'ll need to re-enroll to continue.')) {
                    return;
                }

                try {
                    const response = await fetch(`/api/v1/learning-paths/${pathId}/enroll`, {
                        method: 'DELETE'
                    });

                    const data = await response.json();
                    if (response.ok && data.status === 'success') {
                        showToast('Successfully left learning path', 'success');
                        setTimeout(() => {
                            location.reload();
                        }, 1000);
                    } else {
                        showToast(data.message || 'Failed to leave learning path', 'error');
                    }
                } catch (error) {
                    console.error('Error unenrolling:', error);
                    showToast('Failed to leave learning path', 'error');
                }
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadUserRating();
            loadRatings();
        });

        document.addEventListener('DOMContentLoaded', function() {
            // Enroll button is now handled by learning-paths.js
            // This ensures it works even if JS file loads late
            const enrollBtn = document.getElementById('enroll-btn');
            if (enrollBtn && pathId) {
                enrollBtn.setAttribute('data-path-id', pathId);
                // Wait for script to load
                setTimeout(() => {
                    if (window.LearningPaths && window.LearningPaths.enhanceEnrollButton) {
                        window.LearningPaths.enhanceEnrollButton(enrollBtn);
                    } else {
                        // Fallback if script hasn't loaded
                        enhanceEnrollButton(enrollBtn);
                    }
                }, 100);
            }
            
            // Animate progress bar on load
            const progressBar = document.querySelector('.progress-bar .progress-bar');
            if (progressBar && isEnrolled) {
                const percent = parseInt(progressBar.style.width) || 0;
                if (percent > 0) {
                    progressBar.style.width = '0%';
                    setTimeout(() => {
                        if (window.LearningPaths) {
                            window.LearningPaths.updateProgressWithAnimation(progressBar, percent);
                        }
                    }, 500);
                }
            }

            // Update progress when tutorial is completed
            if (isEnrolled) {
                // This will be called when user completes a tutorial
                window.addEventListener('tutorialCompleted', function(event) {
                    const tutorialId = event.detail.tutorialId;
                    updatePathProgress(tutorialId);
                });
            }
        });

        async function updatePathProgress(tutorialId) {
            if (!pathId || !tutorialId) return;

            try {
                const response = await fetch(`/api/v1/learning-paths/${pathId}/progress/${tutorialId}`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    // Show success toast
                    if (window.LearningPaths) {
                        window.LearningPaths.showToast('Progress updated!', 'success');
                    }
                    
                    // Animate progress bar update
                    const progressBar = document.querySelector('.progress-bar .progress-bar');
                    if (progressBar && window.LearningPaths) {
                        // Get updated progress (would need API call to get latest)
                        // For now, just reload after animation
                    }
                    
                    // Reload to show updated progress
                    setTimeout(() => window.location.reload(), 1500);
                }
            } catch (error) {
                console.error('Progress update error:', error);
            }
        }
    </script>
</body>

</html>

