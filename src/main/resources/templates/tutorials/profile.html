<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{tutorials/layout}">

<head>
    <title>My Profile - JavaMaster</title>
</head>

<body>
    <div layout:fragment="content">
        <div class="container-fluid px-4 py-4">
            <!-- Profile Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="premium-card p-4">
                        <div class="d-flex align-items-center">
                            <div class="profile-avatar me-4">
                                <i class="fas fa-user-circle fa-5x text-primary"></i>
                            </div>
                            <div>
                                <h1 class="h2 mb-1" th:text="${#authentication.principal.username}">Username</h1>
                                <p class="text-muted mb-2">Java Learner</p>
                                <div class="d-flex gap-3">
                                    <span class="badge bg-primary" id="badge-count">
                                        <i class="fas fa-award me-1"></i>
                                        <span id="badge-count-value">0</span> Badges
                                    </span>
                                    <span class="badge bg-success" id="tutorials-completed">
                                        <i class="fas fa-book-reader me-1"></i>
                                        <span id="tutorials-count-value">0</span> Tutorials
                                    </span>
                                    <span class="badge bg-info" id="quizzes-passed">
                                        <i class="fas fa-check-circle me-1"></i>
                                        <span id="quizzes-count-value">0</span> Quizzes
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Content Tabs -->
            <div class="row">
                <div class="col-12">
                    <ul class="nav nav-tabs mb-4" id="profileTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="badges-tab" data-bs-toggle="tab"
                                data-bs-target="#badges-content" type="button" role="tab">
                                <i class="fas fa-medal me-2 text-warning"></i>My Badges
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="security-tab" data-bs-toggle="tab"
                                data-bs-target="#security-content" type="button" role="tab">
                                <i class="fas fa-shield-alt me-2 text-info"></i>Security Settings
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content" id="profileTabsContent">
                        <!-- Badges Tab -->
                        <div class="tab-pane fade show active" id="badges-content" role="tabpanel">
                            <!-- Loading State -->
                            <div id="badges-loading" class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="text-muted mt-2">Loading badges...</p>
                            </div>

                            <!-- Badges Grid -->
                            <div id="badges-container" class="row g-4" style="display: none;">
                                <!-- Badges will be dynamically loaded here -->
                            </div>

                            <!-- Empty State -->
                            <div id="badges-empty" class="text-center py-5" style="display: none;">
                                <i class="fas fa-trophy fa-4x text-muted mb-3"></i>
                                <h4 class="text-muted">No badges yet</h4>
                                <p class="text-muted">Complete tutorials and quizzes to earn badges!</p>
                                <a th:href="@{/tutorials}" class="btn btn-primary">
                                    <i class="fas fa-book me-2"></i>Start Learning
                                </a>
                            </div>
                        </div>

                        <!-- Security Tab -->
                        <div class="tab-pane fade" id="security-content" role="tabpanel">
                            <div class="row justify-content-center">
                                <div class="col-md-6">
                                    <div class="premium-card p-4">
                                        <h3 class="h5 mb-4 border-bottom pb-2">
                                            <i class="fas fa-key text-primary me-2"></i>Change Password
                                        </h3>
                                        <form id="change-password-form">
                                            <div class="mb-3">
                                                <label class="form-label text-muted">Current Password</label>
                                                <input type="password" class="form-control" name="oldPassword" required>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label text-muted">New Password</label>
                                                <input type="password" class="form-control" id="newPassword"
                                                    name="newPassword" required>
                                            </div>
                                            <div class="mb-4">
                                                <label class="form-label text-muted">Confirm New Password</label>
                                                <input type="password" class="form-control" id="confirmPassword"
                                                    required>
                                            </div>
                                            <button type="submit" class="btn btn-primary w-100"
                                                id="password-submit-btn">
                                                <span id="btn-text">Update Password</span>
                                                <div id="btn-spinner" class="spinner-border spinner-border-sm ms-2"
                                                    style="display: none;"></div>
                                            </button>
                                        </form>
                                        <div id="password-feedback" class="mt-3" style="display: none;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <th:block layout:fragment="scripts">
        <style>
            .badge-card {
                background: var(--dark-card);
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 1rem;
                padding: 1.5rem;
                text-align: center;
                transition: all 0.3s ease;
            }

            .badge-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            }

            .badge-card.earned {
                border-color: var(--primary-color);
                background: linear-gradient(135deg, rgba(0, 132, 255, 0.1), rgba(0, 198, 255, 0.05));
            }

            .badge-card.locked {
                opacity: 0.6;
            }

            .badge-icon {
                font-size: 3rem;
                margin-bottom: 1rem;
            }

            .badge-card.locked .badge-icon {
                filter: grayscale(100%);
            }

            .badge-name {
                font-weight: 600;
                font-size: 1.1rem;
                margin-bottom: 0.5rem;
            }

            .badge-description {
                color: var(--text-muted);
                font-size: 0.85rem;
                margin-bottom: 0.75rem;
            }

            .badge-progress {
                height: 6px;
                background: rgba(255, 255, 255, 0.1);
                border-radius: 3px;
                overflow: hidden;
                margin-top: 0.5rem;
            }

            .badge-progress-bar {
                height: 100%;
                background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
                border-radius: 3px;
                transition: width 0.5s ease;
            }

            .earned-date {
                font-size: 0.75rem;
                color: var(--text-muted);
                margin-top: 0.5rem;
            }

            .profile-avatar {
                width: 100px;
                height: 100px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
        </style>

        <script th:inline="javascript">
            document.addEventListener('DOMContentLoaded', async function () {
                await loadBadges();
            });

            async function loadBadges() {
                const loadingEl = document.getElementById('badges-loading');
                const containerEl = document.getElementById('badges-container');
                const emptyEl = document.getElementById('badges-empty');

                try {
                    const response = await fetch('/api/v1/badges');

                    if (!response.ok) {
                        throw new Error('Failed to load badges');
                    }

                    const badges = await response.json();

                    loadingEl.style.display = 'none';

                    if (badges.length === 0) {
                        emptyEl.style.display = 'block';
                        return;
                    }

                    // Count earned badges
                    const earnedCount = badges.filter(b => b.earned).length;
                    document.getElementById('badge-count-value').textContent = earnedCount;

                    containerEl.style.display = 'flex';
                    containerEl.innerHTML = '';

                    badges.forEach(badge => {
                        const badgeHtml = createBadgeCard(badge);
                        containerEl.innerHTML += badgeHtml;
                    });

                } catch (error) {
                    console.error('Error loading badges:', error);
                    loadingEl.innerHTML = `
                        <i class="fas fa-exclamation-circle fa-3x text-danger mb-3"></i>
                        <p class="text-muted">Failed to load badges. Please try again.</p>
                    `;
                }
            }

            function createBadgeCard(badge) {
                const earnedClass = badge.earned ? 'earned' : 'locked';
                const progressPercent = badge.earned ? 100 :
                    Math.min(100, Math.round((badge.userProgress / badge.requiredCount) * 100));

                const shareButtons = badge.earned ? `
                    <div class="share-buttons mt-2">
                        <button class="btn btn-sm btn-outline-primary share-btn" data-platform="twitter" data-badge="${badge.name}">
                            <i class="fab fa-twitter"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-info share-btn" data-platform="linkedin" data-badge="${badge.name}">
                            <i class="fab fa-linkedin"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-light share-btn" data-platform="copy" data-badge="${badge.name}">
                            <i class="fas fa-link"></i>
                        </button>
                    </div>
                ` : '';

                return `
                    <div class="col-6 col-md-4 col-lg-3">
                        <div class="badge-card ${earnedClass}">
                            <div class="badge-icon">${badge.iconEmoji || 'üèÖ'}</div>
                            <div class="badge-name">${badge.name}</div>
                            <div class="badge-description">${badge.description}</div>
                            ${badge.earned ? `
                                <span class="badge bg-success">
                                    <i class="fas fa-check me-1"></i>Earned
                                </span>
                                <div class="earned-date">${badge.earnedAt}</div>
                                ${shareButtons}
                            ` : `
                                <div class="badge-progress">
                                    <div class="badge-progress-bar" style="width: ${progressPercent}%"></div>
                                </div>
                                <div class="earned-date">${badge.userProgress || 0}/${badge.requiredCount}</div>
                            `}
                        </div>
                    </div>
                `;
            }

            // Change Password Logic
            const passwordForm = document.getElementById('change-password-form');
            const passwordSubmitBtn = document.getElementById('password-submit-btn');
            const btnText = document.getElementById('btn-text');
            const btnSpinner = document.getElementById('btn-spinner');
            const passwordFeedback = document.getElementById('password-feedback');

            if (passwordForm) {
                passwordForm.addEventListener('submit', async function (e) {
                    e.preventDefault();

                    const oldPassword = passwordForm.oldPassword.value;
                    const newPassword = passwordForm.newPassword.value;
                    const confirmPassword = document.getElementById('confirmPassword').value;

                    // Frontend validation
                    if (newPassword !== confirmPassword) {
                        showFeedback('New passwords do not match!', 'danger');
                        return;
                    }

                    if (newPassword.length < 5) {
                        showFeedback('New password must be at least 5 characters long.', 'danger');
                        return;
                    }

                    setLoading(true);

                    try {
                        const response = await fetch('/api/auth/change-password', {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRF-TOKEN': document.querySelector('input[name="_csrf"]')?.value
                            },
                            body: JSON.stringify({ oldPassword, newPassword })
                        });

                        const result = await response.json();

                        if (response.ok) {
                            showFeedback('Password updated successfully!', 'success');
                            passwordForm.reset();
                        } else {
                            showFeedback(result.message || 'Failed to update password. Check your current password.', 'danger');
                        }
                    } catch (error) {
                        console.error('Error changing password:', error);
                        showFeedback('An unexpected error occurred. Please try again.', 'danger');
                    } finally {
                        setLoading(false);
                    }
                });
            }

            function showFeedback(message, type) {
                passwordFeedback.style.display = 'block';
                passwordFeedback.className = `mt-3 alert alert-${type}`;
                passwordFeedback.textContent = message;

                if (type === 'success') {
                    setTimeout(() => {
                        passwordFeedback.style.display = 'none';
                    }, 5000);
                }
            }

            function setLoading(isLoading) {
                passwordSubmitBtn.disabled = isLoading;
                btnText.textContent = isLoading ? 'Updating...' : 'Update Password';
                btnSpinner.style.display = isLoading ? 'inline-block' : 'none';
            }

            // Social sharing event handlers
            document.addEventListener('click', function (e) {
                if (e.target.closest('.share-btn')) {
                    const btn = e.target.closest('.share-btn');
                    const platform = btn.dataset.platform;
                    const badgeName = btn.dataset.badge;
                    const username = /*[[${#authentication.principal.username}]]*/ 'User';
                    const shareText = `üèÜ I just earned the "${badgeName}" badge on JavaMaster! Join me in learning Java. #JavaMaster #Coding`;
                    const shareUrl = window.location.origin + '/tutorials';

                    switch (platform) {
                        case 'twitter':
                            window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(shareUrl)}`, '_blank', 'width=600,height=400');
                            break;
                        case 'linkedin':
                            window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(shareUrl)}`, '_blank', 'width=600,height=400');
                            break;
                        case 'copy':
                            const textToCopy = `${shareText} ${shareUrl}`;
                            navigator.clipboard.writeText(textToCopy).then(() => {
                                btn.innerHTML = '<i class="fas fa-check"></i>';
                                setTimeout(() => btn.innerHTML = '<i class="fas fa-link"></i>', 2000);
                            });
                            break;
                    }
                }
            });
        </script>
    </th:block>
</body>

</html>