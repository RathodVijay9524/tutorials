<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{tutorials/layout}">

<head>
    <title th:text="${lesson.title + ' - ' + course.title}">Watch Lesson</title>
</head>

<body>
    <div layout:fragment="content">
        <div class="row g-0 bg-dark rounded-4 overflow-hidden shadow-2xl mb-4">
            <!-- Video Player Area -->
            <div class="col-lg-8 border-end border-secondary border-opacity-25">
                <div class="ratio ratio-16x9 bg-black">
                    <!-- Check for YouTube vs Direct URL -->
                    <iframe
                        th:if="${#strings.contains(lesson.videoUrl, 'youtube.com') || #strings.contains(lesson.videoUrl, 'youtu.be')}"
                        th:src="${#strings.contains(lesson.videoUrl, 'watch?v=') ? #strings.replace(lesson.videoUrl, 'watch?v=', 'embed/') : lesson.videoUrl}"
                        title="YouTube video player" frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                        allowfullscreen></iframe>

                    <video
                        th:unless="${#strings.contains(lesson.videoUrl, 'youtube.com') || #strings.contains(lesson.videoUrl, 'youtu.be')}"
                        controls class="w-100 h-100">
                        <source th:src="${lesson.videoUrl}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                </div>
            </div>

            <!-- Content Navigation Sidebar -->
            <div class="col-lg-4 d-flex flex-column" style="max-height: calc(8/16 * 100vw);">
                <div class="p-4 bg-dark text-white border-bottom border-secondary border-opacity-25">
                    <h5 class="fw-bold outfit-font mb-1">Course Content</h5>
                    <div class="small opacity-50" th:text="${course.lessons.size() + ' Total Lessons'}">10 Total Lessons
                    </div>
                </div>
                <div class="flex-grow-1 overflow-auto bg-dark custom-scrollbar">
                    <div class="list-group list-group-flush">
                        <a th:each="clesson : ${course.lessons}"
                            th:href="@{/tutorials/courses/{courseSlug}/watch/{lessonSlug}(courseSlug=${course.slug}, lessonSlug=${clesson.slug})}"
                            class="list-group-item list-group-item-action bg-dark text-white border-secondary border-opacity-10 py-3"
                            th:classappend="${clesson.id == lesson.id} ? 'active-lesson' : ''">
                            <div class="d-flex align-items-center gap-3">
                                <div class="lesson-num fw-bold small"
                                    th:classappend="${clesson.id == lesson.id} ? 'bg-primary' : 'bg-secondary bg-opacity-25'"
                                    th:text="${clesson.lessonOrder}">1</div>
                                <div class="flex-grow-1 small" th:text="${clesson.title}">Lesson Title</div>
                                <div th:if="${clesson.id == lesson.id}" class="text-primary"><i class="fas fa-play"></i>
                                </div>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lesson Info -->
        <div class="row">
            <div class="col-lg-8">
                <div class="p-4 bg-white rounded-4 shadow-sm">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="fw-bold outfit-font mb-0" th:text="${lesson.title}">Lesson Title</h2>
                    </div>

                    <div class="lesson-summary text-muted" style="white-space: pre-line;" th:text="${lesson.summary}">
                        Lesson summary content goes here...
                    </div>

                    <hr class="my-5">

                    <!-- Rating Section -->
                    <div class="mb-5">
                        <h4 class="fw-bold outfit-font mb-4"><i class="fas fa-star text-warning me-2"></i>Rate This
                            Lesson</h4>

                        <!-- Rating Summary -->
                        <div id="ratingSummary" class="mb-4">
                            <div class="d-flex align-items-center gap-3 mb-3">
                                <div class="display-4 fw-bold" id="avgRating">0.0</div>
                                <div>
                                    <div id="ratingStars" class="fs-4 text-warning mb-1">
                                        <i class="far fa-star"></i>
                                        <i class="far fa-star"></i>
                                        <i class="far fa-star"></i>
                                        <i class="far fa-star"></i>
                                        <i class="far fa-star"></i>
                                    </div>
                                    <div class="text-muted small" id="ratingCount">0 ratings</div>
                                </div>
                            </div>
                        </div>

                        <!-- User Rating Form -->
                        <div class="card border-0 bg-light p-4 rounded-3">
                            <h6 class="fw-semibold mb-3">Your Rating</h6>
                            <div class="mb-3">
                                <div id="userRatingStars" class="fs-3" style="cursor: pointer;">
                                    <i class="far fa-star" data-rating="1"></i>
                                    <i class="far fa-star" data-rating="2"></i>
                                    <i class="far fa-star" data-rating="3"></i>
                                    <i class="far fa-star" data-rating="4"></i>
                                    <i class="far fa-star" data-rating="5"></i>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="reviewText" class="form-label">Review (Optional)</label>
                                <textarea class="form-control" id="reviewText" rows="3"
                                    placeholder="Share your thoughts about this lesson..."></textarea>
                            </div>
                            <button type="button" class="btn btn-primary" id="submitRating">
                                <i class="fas fa-paper-plane me-2"></i>Submit Rating
                            </button>
                        </div>
                    </div>

                    <hr class="my-5">

                    <!-- Reviews Section -->
                    <div class="mb-5" id="reviewsSection">
                        <h4 class="fw-bold outfit-font mb-4"><i class="fas fa-comments me-2"></i>Reviews</h4>
                        <div id="reviewsList">
                            <p class="text-muted">No reviews yet. Be the first to share your thoughts!</p>
                        </div>
                    </div>

                    <hr class="my-5">

                    <!-- Discussion/Comments Section -->
                    <div class="mb-5">
                        <h4 class="fw-bold outfit-font mb-4">
                            <i class="fas fa-comment-dots me-2"></i>Discussion
                            <span class="badge bg-secondary" id="commentCount">0 comments</span>
                        </h4>

                        <!-- Add Comment Form -->
                        <div class="card border-0 bg-light p-4 rounded-3 mb-4">
                            <textarea class="form-control mb-3" id="newCommentText" rows="3"
                                placeholder="Join the discussion..."></textarea>
                            <button type="button" class="btn btn-primary" id="postComment">
                                <i class="fas fa-paper-plane me-2"></i>Post Comment
                            </button>
                        </div>

                        <!-- Comments List -->
                        <div id="commentsList">
                            <p class="text-muted">No comments yet. Start the discussion!</p>
                        </div>
                    </div>

                    <hr class="my-5">

                    <div class="d-flex justify-content-between">
                        <!-- Navigation Buttons -->
                        <div th:each="i : ${#numbers.sequence(0, course.lessons.size() - 1)}"
                            th:if="${course.lessons[i].id == lesson.id}">
                            <a th:if="${i > 0}"
                                th:href="@{/tutorials/courses/{courseSlug}/watch/{lessonSlug}(courseSlug=${course.slug}, lessonSlug=${course.lessons[i-1].slug})}"
                                class="btn btn-outline-secondary rounded-pill px-4">
                                <i class="fas fa-arrow-left me-2"></i>Previous Lesson
                            </a>
                        </div>

                        <div th:each="i : ${#numbers.sequence(0, course.lessons.size() - 1)}"
                            th:if="${course.lessons[i].id == lesson.id}">
                            <a th:if="${i < course.lessons.size() - 1}"
                                th:href="@{/tutorials/courses/{courseSlug}/watch/{lessonSlug}(courseSlug=${course.slug}, lessonSlug=${course.lessons[i+1].slug})}"
                                class="btn btn-primary rounded-pill px-4">
                                Next Lesson<i class="fas fa-arrow-right ms-2"></i>
                            </a>
                            <a th:if="${i == course.lessons.size() - 1}"
                                th:href="@{/tutorials/courses/view/{slug}(slug=${course.slug})}"
                                class="btn btn-success rounded-pill px-4">
                                Course Completed<i class="fas fa-check ms-2"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <th:block layout:fragment="styles">
        <style>
            .outfit-font {
                font-family: 'Outfit', sans-serif;
            }

            .active-lesson {
                background-color: rgba(99, 102, 241, 0.1) !important;
                border-left: 4px solid var(--bs-primary) !important;
            }

            .lesson-num {
                width: 24px;
                height: 24px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
                font-size: 0.75rem;
            }

            .custom-scrollbar::-webkit-scrollbar {
                width: 6px;
            }

            .custom-scrollbar::-webkit-scrollbar-track {
                background: #000;
            }

            .custom-scrollbar::-webkit-scrollbar-thumb {
                background: #333;
                border-radius: 10px;
            }

            .custom-scrollbar::-webkit-scrollbar-thumb:hover {
                background: #444;
            }
        </style>
    </th:block>

    <th:block layout:fragment="scripts">
        <script th:inline="javascript">
            /*<![CDATA[*/
            const lessonId = /*[[${lesson.id}]]*/ 0;
            const currentUserId = /*[[${#authentication.principal != 'anonymousUser' ? #authentication.principal.id : null}]]*/ null;
            /*]]>*/

            document.addEventListener('DOMContentLoaded', function () {
                loadRatingSummary();
                loadUserRating();
                loadComments();
                loadReviews();

                // Rating stars hover/click logic
                const userStars = document.querySelectorAll('#userRatingStars i');
                let selectedRating = 0;

                userStars.forEach(star => {
                    star.addEventListener('mouseover', function () {
                        const rating = parseInt(this.getAttribute('data-rating'));
                        highlightStars(rating);
                    });

                    star.addEventListener('mouseout', function () {
                        highlightStars(selectedRating);
                    });

                    star.addEventListener('click', function () {
                        selectedRating = parseInt(this.getAttribute('data-rating'));
                        highlightStars(selectedRating);
                    });
                });

                function highlightStars(rating) {
                    userStars.forEach(star => {
                        const starRating = parseInt(star.getAttribute('data-rating'));
                        if (starRating <= rating) {
                            star.classList.remove('far');
                            star.classList.add('fas', 'text-warning');
                        } else {
                            star.classList.remove('fas', 'text-warning');
                            star.classList.add('far');
                        }
                    });
                }

                // Submit Rating
                document.getElementById('submitRating').addEventListener('click', function () {
                    if (selectedRating === 0) {
                        alert('Please select a star rating');
                        return;
                    }

                    const review = document.getElementById('reviewText').value;

                    fetch(`/api/v1/lesson-ratings/lesson/${lessonId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            // Add CSRF token if required
                            'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]')?.content
                        },
                        body: JSON.stringify({
                            rating: selectedRating,
                            review: review
                        })
                    })
                        .then(response => {
                            if (response.ok) {
                                alert('Rating submitted successfully!');
                                loadRatingSummary();
                                loadReviews();
                            } else if (response.status === 403 || response.status === 401) {
                                alert('Please login to rate this lesson');
                            } else {
                                alert('Error submitting rating');
                            }
                        })
                        .catch(error => console.error('Error:', error));
                });

                // Post Comment
                document.getElementById('postComment').addEventListener('click', function () {
                    const content = document.getElementById('newCommentText').value;
                    if (!content.trim()) return;

                    fetch(`/api/v1/lesson-comments/lesson/${lessonId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]')?.content
                        },
                        body: JSON.stringify({
                            content: content,
                            parentId: null
                        })
                    })
                        .then(response => {
                            if (response.ok) {
                                document.getElementById('newCommentText').value = '';
                                loadComments();
                            } else if (response.status === 403 || response.status === 401) {
                                alert('Please login to post a comment');
                            } else {
                                alert('Error posting comment');
                            }
                        })
                        .catch(error => console.error('Error:', error));
                });

                // Load helper functions
                function loadRatingSummary() {
                    fetch(`/api/v1/lesson-ratings/lesson/${lessonId}/summary`)
                        .then(response => response.json())
                        .then(data => {
                            document.getElementById('avgRating').textContent = data.averageRating.toFixed(1);
                            document.getElementById('ratingCount').textContent = `${data.totalRatings} ratings`;

                            const starsContainer = document.getElementById('ratingStars');
                            starsContainer.innerHTML = '';
                            for (let i = 1; i <= 5; i++) {
                                if (i <= Math.round(data.averageRating)) {
                                    starsContainer.innerHTML += '<i class="fas fa-star text-warning"></i>';
                                } else {
                                    starsContainer.innerHTML += '<i class="far fa-star"></i>';
                                }
                            }
                        });
                }

                function loadUserRating() {
                    fetch(`/api/v1/lesson-ratings/lesson/${lessonId}/my-rating`)
                        .then(response => {
                            if (response.status === 200) return response.json();
                            return null;
                        })
                        .then(data => {
                            if (data) {
                                selectedRating = data.rating;
                                highlightStars(selectedRating);
                                document.getElementById('reviewText').value = data.review || '';
                                document.getElementById('submitRating').textContent = 'Update Rating';
                            }
                        });
                }

                function loadReviews() {
                    fetch(`/api/v1/lesson-ratings/lesson/${lessonId}/reviews`)
                        .then(response => response.json())
                        .then(data => {
                            const container = document.getElementById('reviewsList');
                            if (data.length === 0) {
                                container.innerHTML = '<p class="text-muted">No reviews yet.</p>';
                                return;
                            }

                            container.innerHTML = data.map(review => `
                            <div class="mb-4 pb-3 border-bottom">
                                <div class="d-flex align-items-center gap-2 mb-2">
                                    <div class="fw-bold">${review.userName}</div>
                                    <div class="text-warning small">
                                        ${'<i class="fas fa-star"></i>'.repeat(review.rating)}
                                        ${'<i class="far fa-star"></i>'.repeat(5 - review.rating)}
                                    </div>
                                    <div class="text-muted small ms-auto">${new Date(review.createdAt).toLocaleDateString()}</div>
                                </div>
                                <div class="small">${review.review || ''}</div>
                            </div>
                        `).join('');
                        });
                }

                function loadComments() {
                    fetch(`/api/v1/lesson-comments/lesson/${lessonId}`)
                        .then(response => response.json())
                        .then(data => {
                            document.getElementById('commentCount').textContent = `${data.length} comments`;
                            const container = document.getElementById('commentsList');
                            if (data.length === 0) {
                                container.innerHTML = '<p class="text-muted">No comments yet.</p>';
                                return;
                            }

                            renderComments(data, container);
                        });
                }

                function renderComments(comments, container) {
                    container.innerHTML = comments.map(comment => `
                        <div class="d-flex gap-3 mb-4">
                            <img src="/api/v1/files/image/${comment.authorImageName || 'default-avatar.png'}" 
                                 class="rounded-circle" style="width: 40px; height: 40px; object-fit: cover;">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center gap-2 mb-1">
                                    <div class="fw-bold small">${comment.authorName}</div>
                                    <div class="text-muted" style="font-size: 0.7rem;">${new Date(comment.createdAt).toLocaleString()}</div>
                                </div>
                                <div class="mb-2">${comment.content}</div>
                                <div class="d-flex gap-3 small">
                                    <button class="btn btn-link btn-sm p-0 text-decoration-none" onclick="showReplyForm(${comment.id})">Reply</button>
                                    ${comment.canModify ? `
                                        <button class="btn btn-link btn-sm p-0 text-decoration-none text-danger" onclick="deleteComment(${comment.id})">Delete</button>
                                    ` : ''}
                                </div>
                                <div id="replyForm-${comment.id}" class="mt-3 d-none">
                                    <textarea class="form-control form-control-sm mb-2" id="replyText-${comment.id}" rows="2" placeholder="Write a reply..."></textarea>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-primary btn-sm" onclick="postReply(${comment.id})">Post Reply</button>
                                        <button class="btn btn-light btn-sm" onclick="hideReplyForm(${comment.id})">Cancel</button>
                                    </div>
                                </div>
                                <div class="replies-container ms-4 mt-3">
                                    ${comment.replies ? renderReplies(comment.replies) : ''}
                                </div>
                            </div>
                        </div>
                    `).join('');
                }

                function renderReplies(replies) {
                    return replies.map(reply => `
                        <div class="d-flex gap-2 mb-3">
                            <img src="/api/v1/files/image/${reply.authorImageName || 'default-avatar.png'}" 
                                 class="rounded-circle" style="width: 30px; height: 30px; object-fit: cover;">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center gap-2 mb-1">
                                    <div class="fw-bold small" style="font-size: 0.8rem;">${reply.authorName}</div>
                                    <div class="text-muted" style="font-size: 0.65rem;">${new Date(reply.createdAt).toLocaleString()}</div>
                                </div>
                                <div class="small">${reply.content}</div>
                                ${reply.canModify ? `
                                    <button class="btn btn-link btn-sm p-0 text-decoration-none text-danger" style="font-size: 0.7rem;" onclick="deleteComment(${reply.id})">Delete</button>
                                ` : ''}
                            </div>
                        </div>
                    `).join('');
                }

                // Global functions for inline onclick
                window.showReplyForm = (id) => {
                    document.getElementById(`replyForm-${id}`).classList.remove('d-none');
                };
                window.hideReplyForm = (id) => {
                    document.getElementById(`replyForm-${id}`).classList.add('d-none');
                };
                window.postReply = (parentId) => {
                    const content = document.getElementById(`replyText-${parentId}`).value;
                    if (!content.trim()) return;

                    fetch(`/api/v1/lesson-comments/lesson/${lessonId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]')?.content
                        },
                        body: JSON.stringify({
                            content: content,
                            parentId: parentId
                        })
                    })
                        .then(response => {
                            if (response.ok) {
                                loadComments();
                            } else {
                                alert('Error posting reply');
                            }
                        });
                };
                window.deleteComment = (id) => {
                    if (!confirm('Are you sure you want to delete this comment?')) return;

                    fetch(`/api/v1/lesson-comments/${id}`, {
                        method: 'DELETE',
                        headers: {
                            'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]')?.content
                        }
                    })
                        .then(response => {
                            if (response.ok) {
                                loadComments();
                            } else {
                                alert('Error deleting comment');
                            }
                        });
                };
            });
        </script>
    </th:block>
</body>

</html>